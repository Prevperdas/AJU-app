<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <title>Controle Log√≠stico | Otimizado</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.1/dist/browser-image-compression.js"></script>
    <style>
        :root { --cor-principal: #E4002B; --cor-sucesso: #00875A; --cor-erro: #D32F2F; --cor-info: #f0f2f5; --cor-fundo: #f4f7f9; --texto-escuro: #1c1c1e; --texto-claro: #ffffff; --texto-secundario: #6c757d; --borda-suave: #e5e5ea; --font-sm: .9rem; --font-base: 1rem; --font-lg: 1.1rem }
        html { font-size: 16px } body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--cor-fundo); margin: 0; padding: 0; color: var(--texto-escuro); -webkit-font-smoothing: antialiased; line-height: 1.5 } h2, h3, h4 { font-size: var(--font-lg); font-weight: 700; text-transform: uppercase; color: #333; margin: 0 } .header { background-color: var(--texto-escuro); padding: 1rem; box-shadow: 0 2px 5px rgba(0, 0, 0, .2); display: flex; flex-direction: column; align-items: center; gap: 1rem } .logo-container { width: 180px; margin: 0 } .logo-container img { width: 100%; height: auto; display: block } .nav-container { display: flex; width: 100%; max-width: 500px; border-radius: 8px; overflow: hidden; background-color: #444 } .nav-button { flex-grow: 1; background-color: transparent; color: var(--texto-claro); border: none; padding: .75rem .625rem; cursor: pointer; font-size: .875rem; font-weight: 600; text-align: center; text-transform: uppercase; transition: background-color .3s, color .3s } .nav-button:not(:last-child) { border-right: 1px solid #555 } .nav-button.active { background-color: var(--cor-principal); color: var(--texto-claro) } #main-content { padding: 1.5rem .5rem; max-width: 960px; margin: 0 auto } .form-section { display: none; padding: 1.5rem; background: #fff; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, .05); margin-top: 1.25rem } .form-section h2 { margin-bottom: 2.5rem; border-bottom: 3px solid var(--cor-principal); padding-bottom: .75rem } .form-group { margin-bottom: 2.5rem } .form-group>label { display: block; margin-bottom: .75rem; font-weight: 600; font-size: var(--font-base); color: var(--texto-escuro) } .form-group input[type=text], .form-group select, .form-group textarea { width: 100%; padding: 1rem; box-sizing: border-box; border: 1px solid var(--borda-suave); border-radius: 8px; font-size: var(--font-base); background-color: #fff; transition: border-color .3s, box-shadow .3s } .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: var(--cor-principal); outline: none; box-shadow: 0 0 0 3px rgba(228, 0, 43, .15) } .form-group.error-highlight>label, .form-group.error-highlight .lacre-prefix, .input-file-label.error-highlight { color: var(--cor-erro) !important; border-color: var(--cor-erro) !important } .form-group.error-highlight input, .form-group.error-highlight select, .form-group.error-highlight textarea { border-color: var(--cor-erro) } .lacre-group { display: flex } .lacre-prefix { background-color: #f0f2f5; padding: 1rem; border: 1px solid var(--borda-suave); border-right: none; border-radius: 8px 0 0 8px; font-weight: 700; color: var(--texto-escuro); display: flex; align-items: center; font-size: var(--font-base) } .lacre-group input { border-radius: 0 8px 8px 0 } .btn { margin-top: 1.5rem; padding: 1rem 1.5rem; font-size: var(--font-base); font-weight: 700; text-transform: uppercase; background-color: var(--cor-principal); color: #fff; border: none; border-radius: 8px; cursor: pointer; width: 100%; box-shadow: 0 4px 10px rgba(228, 0, 43, .2); transition: all .3s } .btn:hover:not(:disabled) { background-color: #c00024; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(228, 0, 43, .3) } .btn:disabled { background-color: #ccc; box-shadow: none; cursor: not-allowed } .input-file-label { padding: 1rem; font-size: var(--font-base); border-radius: 8px; border: 2px dashed var(--borda-suave); background-color: #fafafa; text-align: center; cursor: pointer; transition: background-color .3s, border-color .3s; font-weight: 500 } .file-name { margin-top: .5rem; font-size: var(--font-sm); color: var(--texto-secundario) } .resultado-conferencia { border-top: 1px solid var(--borda-suave); padding-top: 2rem; margin-top: 2rem } .resultado-conferencia h3, .resultado-conferencia h4 { margin-bottom: 2rem } .info-card { background-color: #fff; border: 1px solid var(--borda-suave); border-radius: 12px; padding: 1.5rem; display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem } .info-item { display: flex; flex-direction: column } .info-label { font-size: var(--font-sm); color: var(--texto-secundario); font-weight: 500; margin-bottom: .25rem } .info-value { font-size: var(--font-base); color: var(--texto-escuro); font-weight: 600 } .lacre-display { font-size: var(--font-lg); font-weight: 700; color: var(--cor-principal); text-align: center; margin: 3rem 0 } .anexos-container { display: flex; flex-direction: column; gap: 1rem } .anexo-item { display: flex; align-items: center; justify-content: center; gap: .75rem; background-color: #fff; border: 1px solid var(--borda-suave); border-radius: 8px; padding: 1rem; text-decoration: none; color: var(--texto-escuro); transition: background-color .2s, box-shadow .2s; font-size: var(--font-base); font-weight: 600 } .anexo-item:hover { background-color: #f8f8f8 } .anexo-item::before { content: 'üîó'; font-size: 1.2em } .radio-options { margin-top: 1rem; display: flex; align-items: center; gap: 2rem } .radio-option-item { display: flex; align-items: center } .radio-option-item input { margin-right: .75rem; transform: scale(1.3) } .radio-option-item label { font-weight: 900; font-size: 1.25rem } .mensagem { padding: 1rem; border-radius: 8px; margin-top: 1.5rem; text-align: center; display: none; font-size: var(--font-base); font-weight: 600 } .mensagem.sucesso { background-color: var(--cor-sucesso); color: var(--texto-claro); display: block } .mensagem.erro { background-color: var(--cor-erro); color: var(--texto-claro); display: block } .mensagem.info { background-color: var(--cor-info); color: var(--texto-escuro); display: block } hr.divisor { border: 0; border-top: 1px solid var(--borda-suave); margin: 3rem 0 } .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, .6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity .3s, visibility .3s } .modal-overlay.show { opacity: 1; visibility: visible } .modal-content { background-color: #fff; padding: 2rem; border-radius: 12px; box-shadow: 0 5px 20px rgba(0, 0, 0, .2); width: 90%; max-width: 400px; text-align: center; transform: scale(.9); transition: transform .3s } .modal-overlay.show .modal-content { transform: scale(1) } .modal-message { font-size: var(--font-lg); font-weight: 500; margin-bottom: 2rem; color: var(--texto-escuro); line-height: 1.4; white-space: pre-wrap } .modal-actions { display: flex; justify-content: center; gap: 1rem } .modal-btn { flex-grow: 1; padding: .8rem 1rem; border-radius: 8px; border: none; font-size: .9rem; font-weight: 700; text-transform: uppercase; cursor: pointer; transition: all .3s } .modal-btn-confirm, .modal-btn-ok { background-color: var(--cor-principal); color: var(--texto-claro) } .modal-btn-confirm:hover, .modal-btn-ok:hover { background-color: #c00024 } .modal-btn-cancel { background-color: #f0f2f5; color: var(--texto-escuro); border: 1px solid var(--borda-suave) } .modal-btn-cancel:hover { background-color: #e5e5ea } .modal-btn-ok { width: 100%; max-width: 120px; margin: 0 auto } .checkbox-group { display: flex; align-items: center; gap: .5rem; margin-bottom: 1.5rem; border-bottom: 2px solid #f0f2f5; padding-bottom: 1.5rem } .checkbox-group label { margin: 0; font-weight: 600; font-size: 1.05rem } .checkbox-group input[type=checkbox] { width: auto; height: 1.2em } .hidden { display: none } .input-group-bitrem { display: flex; align-items: center; gap: .5rem } .input-group-bitrem>div { flex: 1 } .input-divisor { font-size: 1.5rem; font-weight: 700; color: var(--texto-secundario); padding: 0 .25rem } #placa-bitrem-container>label, #lacre-bitrem-container>label { display: block; font-size: .9rem; font-weight: 600; margin-bottom: .75rem; color: var(--texto-escuro) } .input-group-bitrem input[type=text] { font-size: .9rem; padding: .8rem } @media (min-width:768px) { .info-card { grid-template-columns: 1fr 1fr 1fr } .anexos-container { flex-direction: row } }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo-container"><img src="https://logodownload.org/wp-content/uploads/2017/08/centauro-logo-00.png" alt="Logo Centauro"></div>
        <div class="nav-container">
            <button class="nav-button active" onclick="showSection('saida', this)">1. Sa√≠da</button>
            <button class="nav-button" onclick="showSection('recebimento', this)">2. Confer√™ncia</button>
        </div>
    </div>
    <div id="main-content">
        <div id="saida" class="form-section" style="display: block;">
            <h2>Registro de Sa√≠da de Carga</h2>
            <form id="saidaForm" onsubmit="event.preventDefault(); handleSaida(this);">
                <div class="form-group"><label for="vigilante">Vigilante*</label><input type="text" id="vigilante" name="vigilante" required></div>
                <div class="form-group"><label for="origem">Origem *</label><select id="origem" name="origem" required><option value="">Selecione</option><option>CD Extrema</option><option>CD Jarinu</option><option>CT RJ</option><option>CT PB</option><option>CT Itaja√≠</option></select></div>
                <div class="form-group"><label for="destino">Destino *</label><select id="destino" name="destino" required><option value="">Selecione</option><option>CD Extrema</option><option>CD Jarinu</option><option>CT RJ</option><option>CT PB</option><option>CT Itaja√≠</option></select></div>
                <div class="form-group"><label for="transportadora">Transportadora *</label><select id="transportadora" name="transportadora" required><option value="">Selecione</option><option>VBLOG</option><option>Rota Freitas</option><option>Displan</option><option>Yuppie Log</option></select></div>
                <div class="form-group"><label for="motorista">Motorista *</label><input type="text" id="motorista" name="motorista" required></div>
                <div class="form-group"><label for="placaCavalo">Placa Cavalo *</label><input type="text" id="placaCavalo" name="placaCavalo" required oninput="this.value = this.value.toUpperCase()" style="text-transform: uppercase;"></div>
                <div class="checkbox-group"><input type="checkbox" id="isBiTrem" name="isBiTrem" onchange="toggleBiTremFields()"><label for="isBiTrem">A Carreta √© Bi-Trem?</label></div>
                <div class="form-group">
                    <div id="placa-normal-container"><label for="placaCarreta">Placa Carreta *</label><input type="text" id="placaCarreta" name="placaCarreta" required oninput="this.value = this.value.toUpperCase()" style="text-transform: uppercase;"></div>
                    <div id="placa-bitrem-container" class="hidden"><label>Placas Carreta (Bi-Trem) *</label><div class="input-group-bitrem"><div><input type="text" id="placaCarreta1" name="placaCarreta1" placeholder="Placa 1" oninput="this.value = this.value.toUpperCase()" style="text-transform: uppercase;"></div><span class="input-divisor">/</span><div><input type="text" id="placaCarreta2" name="placaCarreta2" placeholder="Placa 2" oninput="this.value = this.value.toUpperCase()" style="text-transform: uppercase;"></div></div></div>
                </div>
                <div class="form-group">
                    <div id="lacre-normal-container"><label for="lacreCarreta">Lacre VBlog *</label><input type="text" id="lacreCarreta" name="lacreCarreta" required></div>
                    <div id="lacre-bitrem-container" class="hidden"><label>Lacres VBlog (Bi-Trem) *</label><div class="input-group-bitrem"><div><input type="text" id="lacreCarreta1" name="lacreCarreta1" placeholder="Lacre 1"></div><span class="input-divisor">/</span><div><input type="text" id="lacreCarreta2" name="lacreCarreta2" placeholder="Lacre 2"></div></div></div>
                </div>
                <div class="form-group"><label for="lacreNumero">Lacre VOID *</label><div class="lacre-group"><span class="lacre-prefix">V</span><input type="text" id="lacreNumero" name="lacreNumero" required placeholder="Apenas n√∫meros"></div></div>
                <div class="form-group"><label for="fotoCarretaSaida" class="input-file-label" data-default-text="Anexar Foto da Carreta *">Anexar Foto da Carreta *</label><input type="file" id="fotoCarretaSaida" name="fileCarreta" style="display:none;" accept="image/*" capture="environment" required onchange="updateFileName(this)"><div class="file-name">Nenhum arquivo selecionado</div></div>
                <div class="form-group"><label for="fotoRegistroSaida" class="input-file-label" data-default-text="Anexar Foto do Registro de Sa√≠da *">Anexar Foto do Registro de Sa√≠da *</label><input type="file" id="fotoRegistroSaida" name="fileRegistroSaida" style="display:none;" accept="image/*" capture="environment" required onchange="updateFileName(this)"><div class="file-name">Nenhum arquivo selecionado</div></div>
                <div class="form-group"><label for="fotoLacreSaida" class="input-file-label" data-default-text="Anexar Foto do Lacre *">Anexar Foto do Lacre VOID*</label><input type="file" id="fotoLacreSaida" name="fileLacre" style="display:none;" accept="image/*" capture="environment" required onchange="updateFileName(this)"><div class="file-name">Nenhum arquivo selecionado</div></div>
                <button type="submit" id="submitBtnSaida" class="btn">Registrar Sa√≠da</button>
                <div id="saidaMensagem" class="mensagem"></div>
            </form>
        </div>
        <div id="recebimento" class="form-section">
            <h2>Confer√™ncia de Recebimento</h2>
            <form id="buscaForm" onsubmit="event.preventDefault(); buscarConferencia();">
                <div class="checkbox-group" style="border-bottom: none; margin-bottom: 0.5rem;"><input type="checkbox" id="isBiTremBusca" onchange="toggleBiTremSearchFields()"><label for="isBiTremBusca">A Carreta √© Bi-Trem?</label></div>
                <div class="form-group">
                    <div id="lacre-busca-normal-container"><label for="searchLacreCarreta">Buscar por Lacre VBlog</label><input type="text" id="searchLacreCarreta" placeholder="Digite o n√∫mero do lacre" required></div>
                    <div id="lacre-busca-bitrem-container" class="hidden"><label>Buscar por Lacres VBlog (Bi-Trem)</label><div class="input-group-bitrem"><div><input type="text" id="searchLacreCarreta1" placeholder="Lacre 1"></div><span class="input-divisor">/</span><div><input type="text" id="searchLacreCarreta2" placeholder="Lacre 2"></div></div></div>
                </div>
                <button type="submit" id="btnBusca" class="btn">Buscar</button>
            </form>
            <div id="recebimentoResultado"></div>
        </div>
    </div>
    <div id="customModal" class="modal-overlay">
        <div class="modal-content">
            <div id="modalMessage" class="modal-message"></div>
            <div id="confirmActions" class="modal-actions"><button id="modalCancelBtn" class="modal-btn modal-btn-cancel">Cancelar</button><button id="modalConfirmBtn" class="modal-btn modal-btn-confirm">Confirmar</button></div>
            <div id="alertActions" class="modal-actions"><button id="modalOkBtn" class="modal-btn modal-btn-ok">OK</button></div>
        </div>
    </div>

    <script>
    const BACKEND_URL = 'https://aju-app.onrender.com'; // <-- üö® ATEN√á√ÉO: VERIFIQUE SE ESTE LINK EST√Å CORRETO!

    // ========================================================================
    // L√ìGICA DE UPLOAD OTIMIZADA (FIRE AND FORGET)
    // ========================================================================
    
    function uploadInBackground(file, uploadUrl) {
        fetch(uploadUrl, { method: 'PUT', body: file })
            .then(response => {
                if (!response.ok) { console.error(`Falha no upload em segundo plano do arquivo ${file.name}. Status: ${response.status}`); } 
                else { console.log(`Upload em segundo plano do arquivo ${file.name} conclu√≠do com sucesso.`); }
            })
            .catch(error => { console.error(`Erro de rede no upload em segundo plano do arquivo ${file.name}:`, error); });
    }

    async function getUploadData(file, msgDiv) {
        if (!file) return null;
        
        let fileToUpload = file;
        const isImage = file.type.match('image.*');
        
        if (isImage) {
            msgDiv.innerHTML = `<strong>Comprimindo imagem: ${file.name}...</strong>`;
            const options = { maxSizeMB: 0.8, maxWidthOrHeight: 1280, useWebWorker: true, initialQuality: 0.7 };
            try {
                fileToUpload = await imageCompression(file, options);
            } catch (error) {
                console.error("Erro na compress√£o, usando original.", error);
            }
        }
        
        msgDiv.innerHTML = `<strong>Obtendo permiss√£o para: ${fileToUpload.name}...</strong>`;
        const response = await fetch(`${BACKEND_URL}/generate_upload_url`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ fileName: fileToUpload.name, mimeType: fileToUpload.type }),
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.erro || 'Falha ao obter URL de upload.');
        
        return { fileToUpload, uploadUrl: data.uploadUrl, fileId: data.fileId };
    }


    async function handleSaida(form) {
        if (isSubmitting) return;
        
        let errors = [], elementsToHighlight = [];
        form.querySelectorAll('.error-highlight').forEach(el => el.classList.remove('error-highlight'));
        form.querySelectorAll('input[type="text"][required], select[required]').forEach(input => {
            if (!input.closest('.hidden') && !input.value.trim()) {
                elementsToHighlight.push(input.closest('.form-group'));
                if (!errors.includes("Preencha todos os campos obrigat√≥rios.")) { errors.push("Preencha todos os campos obrigat√≥rios."); }
            }
        });
        form.querySelectorAll('input[type="file"][required]').forEach(input => {
            if (input.files.length === 0) {
                elementsToHighlight.push(form.querySelector(`label[for="${input.id}"]`));
                if (!errors.includes("Anexe as fotos obrigat√≥rias.")) { errors.push("Anexe as fotos obrigat√≥rias."); }
            }
        });
        if (errors.length > 0) {
            elementsToHighlight.forEach(el => el.classList.add('error-highlight'));
            showCustomAlert("Aten√ß√£o:\n\n- " + errors.join("\n- "));
            return;
        }
        
        showCustomConfirm('Confirmar o envio dos dados de sa√≠da?', async () => {
            const btn = document.getElementById('submitBtnSaida');
            const msgDiv = document.getElementById('saidaMensagem');
            isSubmitting = true;
            btn.disabled = true;
            msgDiv.className = 'mensagem info';
            msgDiv.innerHTML = '<strong>Processando...</strong>';
            msgDiv.style.display = 'block';

            try {
                const formObject = {
                    clientTimestamp: new Date().toISOString(),
                    vigilante: form.vigilante.value, origem: form.origem.value,
                    destino: form.destino.value, transportadora: form.transportadora.value,
                    motorista: form.motorista.value, placaCavalo: form.placaCavalo.value,
                    lacreNumero: form.lacreNumero.value, isBiTrem: form.isBiTrem.checked,
                    placaCarreta: form.placaCarreta.value, placaCarreta1: form.placaCarreta1.value,
                    placaCarreta2: form.placaCarreta2.value, lacreCarreta: form.lacreCarreta.value,
                    lacreCarreta1: form.lacreCarreta1.value, lacreCarreta2: form.lacreCarreta2.value,
                    fileCarreta: null, fileRegistroSaida: null, fileLacre: null,
                };
                
                const filesToProcess = [
                    { key: 'fileCarreta', file: form.fotoCarretaSaida.files[0] },
                    { key: 'fileRegistroSaida', file: form.fotoRegistroSaida.files[0] },
                    { key: 'fileLacre', file: form.fotoLacreSaida.files[0] },
                ];

                for (const item of filesToProcess) {
                    const uploadData = await getUploadData(item.file, msgDiv);
                    if (uploadData) {
                        uploadInBackground(uploadData.fileToUpload, uploadData.uploadUrl);
                        formObject[item.key] = { id: uploadData.fileId };
                    } else {
                        throw new Error(`Arquivo obrigat√≥rio para ${item.key} n√£o foi selecionado.`);
                    }
                }

                const response = await fetch(`${BACKEND_URL}/registrar_saida`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formObject),
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.mensagem || 'Ocorreu um erro no servidor.');

                msgDiv.className = 'mensagem sucesso';
                msgDiv.innerHTML = '<strong>' + data.mensagem + '</strong> <br><small>Os arquivos est√£o sendo enviados em segundo plano.</small>';
                form.reset();
                document.querySelectorAll('.file-name').forEach(el => el.textContent = 'Nenhum arquivo selecionado');
                toggleBiTremFields();

            } catch (error) {
                msgDiv.className = 'mensagem erro';
                msgDiv.innerHTML = '<strong>Erro: ' + error.message + '</strong>';
            } finally {
                btn.disabled = false;
                isSubmitting = false;
            }
        });
    };

    async function finalizarConferencia(form) {
        if (isSubmitting) return;
        
        let errors = [], elementsToHighlight = [];
        form.querySelectorAll('.error-highlight').forEach(el => el.classList.remove('error-highlight'));
        form.querySelectorAll('input[type="radio"][required]').forEach(input => {
            const group = form.querySelectorAll(`input[name="${input.name}"]`);
            if (![...group].some(r => r.checked)) {
                elementsToHighlight.push(input.closest('.form-group'));
                if (!errors.includes("Selecione as op√ß√µes obrigat√≥rias (*).")) { errors.push("Selecione as op√ß√µes obrigat√≥rias (*)."); }
            }
        });
        form.querySelectorAll('input[type="file"][required]').forEach(input => {
            if (input.files.length === 0) {
                elementsToHighlight.push(form.querySelector(`label[for="${input.id}"]`));
                if (!errors.includes("Anexe os arquivos obrigat√≥rios.")) { errors.push("Anexe os arquivos obrigat√≥rios."); }
            }
        });
        const lacreVioladoChecked = form.querySelector('input[name="lacreViolado"]:checked');
        const infoProcedemChecked = form.querySelector('input[name="informacoesProcedem"]:checked');
        const observacoesTextarea = form.querySelector('#observacoes');
        if ((lacreVioladoChecked?.value === 'Sim' || infoProcedemChecked?.value === 'N√£o') && !observacoesTextarea.value.trim()) {
            elementsToHighlight.push(observacoesTextarea.closest('.form-group'));
            const errorMsg = "As Observa√ß√µes s√£o obrigat√≥rias em caso de lacre violado ou informa√ß√µes que n√£o procedem.";
            if (!errors.includes(errorMsg)) { errors.push(errorMsg); }
        }
        if (errors.length > 0) {
            elementsToHighlight.forEach(el => el.classList.add('error-highlight'));
            showCustomAlert("Aten√ß√£o:\n\n- " + errors.join("\n- "));
            return;
        }

        showCustomConfirm('Confirmar a finaliza√ß√£o da confer√™ncia?', async () => {
            const btn = document.getElementById('btnFinalizar');
            const msgDiv = document.getElementById('finalizandoMsg');
            if (foundRowIndex === null) return;

            isSubmitting = true;
            btn.disabled = true;
            msgDiv.className = 'mensagem info';
            msgDiv.innerHTML = '<strong>Processando...</strong>';
            msgDiv.style.display = 'block';

            try {
                const formData = new FormData(form);
                const formObject = { 
                    rowIndex: foundRowIndex,
                    clientTimestamp: new Date().toISOString()
                };
                for (const [key, value] of formData.entries()) {
                    if (!(value instanceof File)) { formObject[key] = value; }
                }

                const filesToProcess = [
                    { key: 'fileStatus', file: form.fileStatus.files[0] },
                    { key: 'fileLacreStatus', file: form.fileLacreStatus.files[0] },
                    { key: 'fileVideoAbertura', file: form.fileVideoAbertura.files[0] },
                ];

                for (const item of filesToProcess) {
                    if (item.file) { 
                        const uploadData = await getUploadData(item.file, msgDiv);
                        if (uploadData) {
                            uploadInBackground(uploadData.fileToUpload, uploadData.uploadUrl);
                            formObject[item.key] = { id: uploadData.fileId };
                        }
                    }
                }

                const response = await fetch(`${BACKEND_URL}/finalizar_recebimento`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formObject),
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.mensagem || 'Falha na atualiza√ß√£o.');

                showCustomAlert(data.mensagem);
                document.getElementById('recebimentoResultado').innerHTML = `<div class="mensagem sucesso"><strong>Processo finalizado!</strong></div>`;
                document.getElementById('buscaForm').reset();
                toggleBiTremSearchFields();

            } catch (error) {
                showCustomAlert("Falha no processo. Detalhe: " + error.message);
                msgDiv.className = 'mensagem erro';
                msgDiv.innerHTML = `<strong>${error.message}</strong>`;
            } finally {
                btn.disabled = false;
                isSubmitting = false;
            }
        });
    };
    
    // ========================================================================
    // FUN√á√ïES AUXILIARES (COMPLETAS)
    // ========================================================================
    
    let isSubmitting = false;
    let foundRowIndex = null;
    const modal = document.getElementById('customModal');
    const modalMessage = document.getElementById('modalMessage');
    const confirmActions = document.getElementById('confirmActions');
    const alertActions = document.getElementById('alertActions');
    const confirmBtn = document.getElementById('modalConfirmBtn');
    const cancelBtn = document.getElementById('modalCancelBtn');
    const okBtn = document.getElementById('modalOkBtn');
    let onConfirmCallback = null;

    function showCustomConfirm(message, callback) { modalMessage.textContent = message; onConfirmCallback = callback; confirmActions.style.display = 'flex'; alertActions.style.display = 'none'; modal.classList.add('show'); }
    function showCustomAlert(message) { modalMessage.textContent = message; confirmActions.style.display = 'none'; alertActions.style.display = 'flex'; modal.classList.add('show'); }
    confirmBtn.addEventListener('click', () => { if (typeof onConfirmCallback === 'function') { onConfirmCallback(); } modal.classList.remove('show'); });
    cancelBtn.addEventListener('click', () => { onConfirmCallback = null; modal.classList.remove('show'); });
    okBtn.addEventListener('click', () => modal.classList.remove('show'));

    function showSection(sectionId, clickedButton) {
        document.querySelectorAll('.form-section').forEach(section => { section.style.display = 'none'; });
        document.getElementById(sectionId).style.display = 'block';
        document.querySelectorAll('.nav-button').forEach(btn => { btn.classList.remove('active'); });
        clickedButton.classList.add('active');
        if (document.getElementById('recebimentoResultado')) { document.getElementById('recebimentoResultado').innerHTML = ''; }
        if (document.getElementById('buscaForm')) { document.getElementById('buscaForm').reset(); }
        toggleBiTremSearchFields();
    }

    function updateFileName(input) {
        const displayDiv = input.nextElementSibling;
        const label = input.previousElementSibling;
        if (label && label.classList.contains('error-highlight')) { label.classList.remove('error-highlight'); }
        if (displayDiv && displayDiv.classList.contains('file-name')) {
            if (input.files && input.files.length > 0) {
                displayDiv.textContent = input.files[0].name;
            } else {
                displayDiv.textContent = 'Nenhum arquivo selecionado';
            }
        }
    }

    window.onload = function() { showSection('saida', document.querySelector('.nav-button.active')); };
    
    function checkFileSize(input, maxSizeMB) {
        if (input.files && input.files.length > 0) {
            const file = input.files[0];
            const fileSizeMB = file.size / 1024 / 1024;
            if (file.type.includes('video') && fileSizeMB > maxSizeMB) {
                showCustomAlert(`Aten√ß√£o:\n\nO v√≠deo selecionado tem ${fileSizeMB.toFixed(1)} MB. \n\nO envio ser√° r√°pido, mas v√≠deos muito grandes podem ocupar mais espa√ßo no Drive.`);
            }
        }
    }
    
    function toggleBiTremFields() {
        const isBiTrem = document.getElementById('isBiTrem').checked;
        document.getElementById('placa-normal-container').classList.toggle('hidden', isBiTrem);
        document.getElementById('placa-bitrem-container').classList.toggle('hidden', !isBiTrem);
        document.getElementById('placaCarreta').required = !isBiTrem;
        document.getElementById('placaCarreta1').required = isBiTrem;
        document.getElementById('placaCarreta2').required = isBiTrem;
        document.getElementById('lacre-normal-container').classList.toggle('hidden', isBiTrem);
        document.getElementById('lacre-bitrem-container').classList.toggle('hidden', !isBiTrem);
        document.getElementById('lacreCarreta').required = !isBiTrem;
        document.getElementById('lacreCarreta1').required = isBiTrem;
        document.getElementById('lacreCarreta2').required = isBiTrem;
    }

    function toggleBiTremSearchFields() {
        const isBiTrem = document.getElementById('isBiTremBusca').checked;
        document.getElementById('lacre-busca-normal-container').classList.toggle('hidden', isBiTrem);
        document.getElementById('lacre-busca-bitrem-container').classList.toggle('hidden', !isBiTrem);
        document.getElementById('searchLacreCarreta').required = !isBiTrem;
        document.getElementById('searchLacreCarreta1').required = isBiTrem;
        document.getElementById('searchLacreCarreta2').required = isBiTrem;
    }
    
    function buscarConferencia() {
        const isBiTrem = document.getElementById('isBiTremBusca').checked;
        let lacreCarreta = "";
        if (isBiTrem) {
            const lacre1 = document.getElementById('searchLacreCarreta1').value.trim();
            const lacre2 = document.getElementById('searchLacreCarreta2').value.trim();
            if (!lacre1 || !lacre2) { return showCustomAlert("Para busca Bi-Trem, ambos os campos de lacre devem ser preenchidos."); }
            lacreCarreta = `${lacre1} / ${lacre2}`;
        } else {
            lacreCarreta = document.getElementById('searchLacreCarreta').value.trim();
            if (!lacreCarreta) { return showCustomAlert("O campo de busca do lacre deve ser preenchido."); }
        }
        const resultadoDiv = document.getElementById('recebimentoResultado');
        const btnBusca = document.getElementById('btnBusca');
        btnBusca.disabled = true;
        resultadoDiv.innerHTML = `<div class="mensagem info" style="display:block;">Buscando pend√™ncia pelo lacre ${lacreCarreta}...</div>`;

        fetch(`${BACKEND_URL}/buscar_recebimento`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ lacreCarretaBusca: lacreCarreta })
        })
        .then(response => response.json().then(data => ({ ok: response.ok, data })))
        .then(({ ok, data }) => {
            if (!ok) { throw new Error(data.erro || 'Erro ao buscar dados.'); }
            const item = data.resultados[0];
            foundRowIndex = item.rowIndex;
            resultadoDiv.innerHTML = `
                <div class="resultado-conferencia">
                    <h3>Pend√™ncia Encontrada</h3>
                    <div class="info-card">
                        <div class="info-item"><span class="info-label">Registro (Sa√≠da)</span><span class="info-value">${item.Data}</span></div>
                        <div class="info-item"><span class="info-label">Vigilante</span><span class="info-value">${item.Vigilante}</span></div>
                        <div class="info-item"><span class="info-label">Rota</span><span class="info-value">${item.Origem} ‚Üí ${item.Destino}</span></div>
                        <div class="info-item"><span class="info-label">Transportadora</span><span class="info-value">${item.Transportadora}</span></div>
                        <div class="info-item"><span class="info-label">Motorista</span><span class="info-value">${item.Motorista}</span></div>
                        <div class="info-item"><span class="info-label">Placa Carreta</span><span class="info-value">${item.Placa_Carreta}</span></div>
                        <div class="info-item"><span class="info-label">Placa Cavalo</span><span class="info-value">${item.Placa_Cavalo}</span></div>
                        <div class="info-item"><span class="info-label">Lacre da Carreta</span><span class="info-value">${item.Lacre_Carreta}</span></div>
                        <div class="info-item"><span class="info-label">Lacre VOID</span><span class="info-value">${item.Lacre_Void}</span></div>
                    </div>
                    <div class="lacre-display">Conferir Lacre VOID: ${item.Lacre_Void}</div>
                    <h4>Anexos da Sa√≠da</h4>
                    <div class="anexos-container">
                        <a href="${item.Foto_Carreta_Saida}" target="_blank" class="anexo-item"><span>VER FOTO DA CARRETA</span></a>
                        <a href="${item.Foto_Registro_Saida}" target="_blank" class="anexo-item"><span>VER FOTO DO REGISTRO</span></a>
                        <a href="${item.Foto_Lacre_Saida}" target="_blank" class="anexo-item"><span>VER FOTO DO LACRE</span></a>
                    </div>
                    <hr class="divisor">
                    <form id="conferenciaForm" onsubmit="event.preventDefault(); finalizarConferencia(this);">
                        <input type="hidden" name="rowIndex" value="${item.rowIndex}">
                        <div class="form-group">
                            <label>Lacre VOID (${item.Lacre_Void}) est√° violado? *</label>
                            <div class="radio-options">
                                <div class="radio-option-item"><input type="radio" id="lacreSim" name="lacreViolado" value="Sim" required><label for="lacreSim"> Sim</label></div>
                                <div class="radio-option-item"><input type="radio" id="lacreNao" name="lacreViolado" value="N√£o"><label for="lacreNao"> N√£o</label></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="fotoLacreStatus" class="input-file-label" data-default-text="Anexar Foto do Lacre VOID *">Anexar Foto do Lacre VOID *</label>
                            <input type="file" id="fotoLacreStatus" name="fileLacreStatus" style="display:none;" accept="image/*" capture="environment" required onchange="updateFileName(this)">
                            <div class="file-name">Nenhum arquivo selecionado</div>
                        </div>
                        <hr class="divisor">
                        <div class="form-group">
                            <label>As informa√ß√µes (placa, motorista, etc) est√£o corretas? *</label>
                            <div class="radio-options">
                                <div class="radio-option-item"><input type="radio" id="infoProcSim" name="informacoesProcedem" value="Sim" required><label for="infoProcSim"> Sim</label></div>
                                <div class="radio-option-item"><input type="radio" id="infoProcNao" name="informacoesProcedem" value="N√£o"><label for="infoProcNao"> N√£o</label></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="observacoes">Observa√ß√µes:</label>
                            <textarea id="observacoes" name="observacoes" rows="4"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="fotoStatus" class="input-file-label" data-default-text="Anexar Foto da Carreta (Chegada) *">Anexar Foto da Carreta (Chegada) *</label>
                            <input type="file" id="fotoStatus" name="fileStatus" style="display:none;" accept="image/*" capture="environment" required onchange="updateFileName(this)">
                            <div class="file-name">Nenhum arquivo selecionado</div>
                        </div>
                        <div class="form-group">
                            <label for="videoAbertura" class="input-file-label" data-default-text="Anexar V√≠deo (opcional)">Anexar V√≠deo (opcional)</label>
                            <input type="file" id="videoAbertura" name="fileVideoAbertura" style="display:none;" accept="video/*" capture="environment" onchange="updateFileName(this); checkFileSize(this, 100);">
                            <div class="file-name">Nenhum arquivo selecionado</div>
                        </div>
                        <button type="submit" id="btnFinalizar" class="btn">Finalizar Confer√™ncia</button>
                        <div id="finalizandoMsg" class="mensagem"></div>
                    </form>
                </div>`;
        })
        .catch(error => {
            resultadoDiv.innerHTML = `<div class="mensagem erro" style="display:block;"><strong>${error.message}</strong></div>`;
        })
        .finally(() => {
            btnBusca.disabled = false;
        });
    }
    </script>
</body>
</html>