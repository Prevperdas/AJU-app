<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <title>Controle Log√≠stico | Otimizado</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.1/dist/browser-image-compression.js"></script>
    <style>
        :root { --cor-principal: #E4002B; --cor-sucesso: #00875A; --cor-erro: #D32F2F; --cor-info: #f0f2f5; --cor-fundo: #f4f7f9; --texto-escuro: #1c1c1e; --texto-claro: #ffffff; --texto-secundario: #6c757d; --borda-suave: #e5e5ea; --font-sm: .9rem; --font-base: 1rem; --font-lg: 1.1rem }
        html { font-size: 16px } body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--cor-fundo); margin: 0; padding: 0; color: var(--texto-escuro); -webkit-font-smoothing: antialiased; line-height: 1.5 } h2, h3, h4 { font-size: var(--font-lg); font-weight: 700; text-transform: uppercase; color: #333; margin: 0 } .header { background-color: var(--texto-escuro); padding: 1rem; box-shadow: 0 2px 5px rgba(0, 0, 0, .2); display: flex; flex-direction: column; align-items: center; gap: 1rem } .logo-container { width: 180px; margin: 0 } .logo-container img { width: 100%; height: auto; display: block } .nav-container { display: flex; width: 100%; max-width: 500px; border-radius: 8px; overflow: hidden; background-color: #444 } .nav-button { flex-grow: 1; background-color: transparent; color: var(--texto-claro); border: none; padding: .75rem .625rem; cursor: pointer; font-size: .875rem; font-weight: 600; text-align: center; text-transform: uppercase; transition: background-color .3s, color .3s } .nav-button:not(:last-child) { border-right: 1px solid #555 } .nav-button.active { background-color: var(--cor-principal); color: var(--texto-claro) } #main-content { padding: 1.5rem .5rem; max-width: 960px; margin: 0 auto } .form-section { display: none; padding: 1.5rem; background: #fff; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, .05); margin-top: 1.25rem } .form-section h2 { margin-bottom: 2.5rem; border-bottom: 3px solid var(--cor-principal); padding-bottom: .75rem } .form-group { margin-bottom: 2.5rem } .form-group>label { display: block; margin-bottom: .75rem; font-weight: 600; font-size: var(--font-base); color: var(--texto-escuro) } .form-group input[type=text], .form-group select, .form-group textarea { width: 100%; padding: 1rem; box-sizing: border-box; border: 1px solid var(--borda-suave); border-radius: 8px; font-size: var(--font-base); background-color: #fff; transition: border-color .3s, box-shadow .3s } .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: var(--cor-principal); outline: none; box-shadow: 0 0 0 3px rgba(228, 0, 43, .15) } .form-group.error-highlight>label, .form-group.error-highlight .lacre-prefix, .input-file-label.error-highlight { color: var(--cor-erro) !important; border-color: var(--cor-erro) !important } .form-group.error-highlight input, .form-group.error-highlight select, .form-group.error-highlight textarea { border-color: var(--cor-erro) } .lacre-group { display: flex } .lacre-prefix { background-color: #f0f2f5; padding: 1rem; border: 1px solid var(--borda-suave); border-right: none; border-radius: 8px 0 0 8px; font-weight: 700; color: var(--texto-escuro); display: flex; align-items: center; font-size: var(--font-base) } .lacre-group input { border-radius: 0 8px 8px 0 } .btn { margin-top: 1.5rem; padding: 1rem 1.5rem; font-size: var(--font-base); font-weight: 700; text-transform: uppercase; background-color: var(--cor-principal); color: #fff; border: none; border-radius: 8px; cursor: pointer; width: 100%; box-shadow: 0 4px 10px rgba(228, 0, 43, .2); transition: all .3s } .btn:hover:not(:disabled) { background-color: #c00024; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(228, 0, 43, .3) } .btn:disabled { background-color: #ccc; box-shadow: none; cursor: not-allowed } .input-file-label { padding: 1rem; font-size: var(--font-base); border-radius: 8px; border: 2px dashed var(--borda-suave); background-color: #fafafa; text-align: center; cursor: pointer; transition: background-color .3s, border-color .3s; font-weight: 500 } .file-name { margin-top: .5rem; font-size: var(--font-sm); color: var(--texto-secundario) } .resultado-conferencia { border-top: 1px solid var(--borda-suave); padding-top: 2rem; margin-top: 2rem } .resultado-conferencia h3, .resultado-conferencia h4 { margin-bottom: 2rem } .info-card { background-color: #fff; border: 1px solid var(--borda-suave); border-radius: 12px; padding: 1.5rem; display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem } .info-item { display: flex; flex-direction: column } .info-label { font-size: var(--font-sm); color: var(--texto-secundario); font-weight: 500; margin-bottom: .25rem } .info-value { font-size: var(--font-base); color: var(--texto-escuro); font-weight: 600 } .lacre-display { font-size: var(--font-lg); font-weight: 700; color: var(--cor-principal); text-align: center; margin: 3rem 0 } .anexos-container { display: flex; flex-direction: column; gap: 1rem } .anexo-item { display: flex; align-items: center; justify-content: center; gap: .75rem; background-color: #fff; border: 1px solid var(--borda-suave); border-radius: 8px; padding: 1rem; text-decoration: none; color: var(--texto-escuro); transition: background-color .2s, box-shadow .2s; font-size: var(--font-base); font-weight: 600 } .anexo-item:hover { background-color: #f8f8f8 } .anexo-item::before { content: 'üîó'; font-size: 1.2em } .radio-options { margin-top: 1rem; display: flex; align-items: center; gap: 2rem } .radio-option-item { display: flex; align-items: center } .radio-option-item input { margin-right: .75rem; transform: scale(1.3) } .radio-option-item label { font-weight: 900; font-size: 1.25rem } .mensagem { padding: 1rem; border-radius: 8px; margin-top: 1.5rem; text-align: center; display: none; font-size: var(--font-base); font-weight: 600 } .mensagem.sucesso { background-color: var(--cor-sucesso); color: var(--texto-claro); display: block } .mensagem.erro { background-color: var(--cor-erro); color: var(--texto-claro); display: block } .mensagem.info { background-color: var(--cor-info); color: var(--texto-escuro); display: block } hr.divisor { border: 0; border-top: 1px solid var(--borda-suave); margin: 3rem 0 } .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, .6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity .3s, visibility .3s } .modal-overlay.show { opacity: 1; visibility: visible } .modal-content { background-color: #fff; padding: 2rem; border-radius: 12px; box-shadow: 0 5px 20px rgba(0, 0, 0, .2); width: 90%; max-width: 400px; text-align: center; transform: scale(.9); transition: transform .3s } .modal-overlay.show .modal-content { transform: scale(1) } .modal-message { font-size: var(--font-lg); font-weight: 500; margin-bottom: 2rem; color: var(--texto-escuro); line-height: 1.4; white-space: pre-wrap } .modal-actions { display: flex; justify-content: center; gap: 1rem } .modal-btn { flex-grow: 1; padding: .8rem 1rem; border-radius: 8px; border: none; font-size: .9rem; font-weight: 700; text-transform: uppercase; cursor: pointer; transition: all .3s } .modal-btn-confirm, .modal-btn-ok { background-color: var(--cor-principal); color: var(--texto-claro) } .modal-btn-confirm:hover, .modal-btn-ok:hover { background-color: #c00024 } .modal-btn-cancel { background-color: #f0f2f5; color: var(--texto-escuro); border: 1px solid var(--borda-suave) } .modal-btn-cancel:hover { background-color: #e5e5ea } .modal-btn-ok { width: 100%; max-width: 120px; margin: 0 auto } .checkbox-group { display: flex; align-items: center; gap: .5rem; margin-bottom: 1.5rem; border-bottom: 2px solid #f0f2f5; padding-bottom: 1.5rem } .checkbox-group label { margin: 0; font-weight: 600; font-size: 1.05rem } .checkbox-group input[type=checkbox] { width: auto; height: 1.2em } .hidden { display: none } .input-group-bitrem { display: flex; align-items: center; gap: .5rem } .input-group-bitrem>div { flex: 1 } .input-divisor { font-size: 1.5rem; font-weight: 700; color: var(--texto-secundario); padding: 0 .25rem } #placa-bitrem-container>label, #lacre-bitrem-container>label { display: block; font-size: .9rem; font-weight: 600; margin-bottom: .75rem; color: var(--texto-escuro) } .input-group-bitrem input[type=text] { font-size: .9rem; padding: .8rem } @media (min-width:768px) { .info-card { grid-template-columns: 1fr 1fr 1fr } .anexos-container { flex-direction: row } }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo-container"><img src="https://logodownload.org/wp-content/uploads/2017/08/centauro-logo-00.png" alt="Logo Centauro"></div>
        <div class="nav-container">
            <button class="nav-button active" onclick="showSection('saida', this)">1. Sa√≠da</button>
            <button class="nav-button" onclick="showSection('recebimento', this)">2. Confer√™ncia</button>
        </div>
    </div>
    <div id="main-content">
        <div id="saida" class="form-section" style="display: block;">
            <h2>Registro de Sa√≠da de Carga</h2>
            <form id="saidaForm" onsubmit="event.preventDefault(); handleSaida(this);">
                <div class="form-group"><label for="vigilante">Vigilante*</label><input type="text" id="vigilante" name="vigilante" required></div>
                <div class="form-group"><label for="origem">Origem *</label><select id="origem" name="origem" required><option value="">Selecione</option><option>CD Extrema</option><option>CD Jarinu</option><option>CT RJ</option><option>CT PB</option><option>CT Itaja√≠</option></select></div>
                <div class="form-group"><label for="destino">Destino *</label><select id="destino" name="destino" required><option value="">Selecione</option><option>CD Extrema</option><option>CD Jarinu</option><option>CT RJ</option><option>CT PB</option><option>CT Itaja√≠</option></select></div>
                <div class="form-group"><label for="transportadora">Transportadora *</label><select id="transportadora" name="transportadora" required><option value="">Selecione</option><option>VBLOG</option><option>Rota Freitas</option><option>Displan</option><option>Yuppie Log</option></select></div>
                <div class="form-group"><label for="motorista">Motorista *</label><input type="text" id="motorista" name="motorista" required></div>
                <div class="form-group"><label for="placaCavalo">Placa Cavalo *</label><input type="text" id="placaCavalo" name="placaCavalo" required oninput="this.value = this.value.toUpperCase()" style="text-transform: uppercase;"></div>
                <div class="checkbox-group"><input type="checkbox" id="isBiTrem" name="isBiTrem" onchange="toggleBiTremFields()"><label for="isBiTrem">A Carreta √© Bi-Trem?</label></div>
                <div class="form-group">
                    <div id="placa-normal-container"><label for="placaCarreta">Placa Carreta *</label><input type="text" id="placaCarreta" name="placaCarreta" required oninput="this.value = this.value.toUpperCase()" style="text-transform: uppercase;"></div>
                    <div id="placa-bitrem-container" class="hidden"><label>Placas Carreta (Bi-Trem) *</label><div class="input-group-bitrem"><div><input type="text" id="placaCarreta1" name="placaCarreta1" placeholder="Placa 1" oninput="this.value = this.value.toUpperCase()" style="text-transform: uppercase;"></div><span class="input-divisor">/</span><div><input type="text" id="placaCarreta2" name="placaCarreta2" placeholder="Placa 2" oninput="this.value = this.value.toUpperCase()" style="text-transform: uppercase;"></div></div></div>
                </div>
                <div class="form-group">
                    <div id="lacre-normal-container"><label for="lacreCarreta">Lacre VBlog *</label><input type="text" id="lacreCarreta" name="lacreCarreta" required></div>
                    <div id="lacre-bitrem-container" class="hidden"><label>Lacres VBlog (Bi-Trem) *</label><div class="input-group-bitrem"><div><input type="text" id="lacreCarreta1" name="lacreCarreta1" placeholder="Lacre 1"></div><span class="input-divisor">/</span><div><input type="text" id="lacreCarreta2" name="lacreCarreta2" placeholder="Lacre 2"></div></div></div>
                </div>
                <div class="form-group"><label for="lacreNumero">Lacre VOID *</label><div class="lacre-group"><span class="lacre-prefix">V</span><input type="text" id="lacreNumero" name="lacreNumero" required placeholder="Apenas n√∫meros"></div></div>
                <div class="form-group"><label for="fotoCarretaSaida" class="input-file-label" data-default-text="Anexar Foto da Carreta *">Anexar Foto da Carreta *</label><input type="file" id="fotoCarretaSaida" name="fileCarreta" style="display:none;" required onchange="updateFileName(this)"><div class="file-name">Nenhum arquivo selecionado</div></div>
                <div class="form-group"><label for="fotoRegistroSaida" class="input-file-label" data-default-text="Anexar Foto do Registro de Sa√≠da *">Anexar Foto do Registro de Sa√≠da *</label><input type="file" id="fotoRegistroSaida" name="fileRegistroSaida" style="display:none;" required onchange="updateFileName(this)"><div class="file-name">Nenhum arquivo selecionado</div></div>
                <div class="form-group"><label for="fotoLacreSaida" class="input-file-label" data-default-text="Anexar Foto do Lacre *">Anexar Foto do Lacre VOID*</label><input type="file" id="fotoLacreSaida" name="fileLacre" style="display:none;" required onchange="updateFileName(this)"><div class="file-name">Nenhum arquivo selecionado</div></div>
                <button type="submit" id="submitBtnSaida" class="btn">Registrar Sa√≠da</button>
                <div id="saidaMensagem" class="mensagem"></div>
            </form>
        </div>
        <div id="recebimento" class="form-section">
            <h2>Confer√™ncia de Recebimento</h2>
            <form id="buscaForm" onsubmit="event.preventDefault(); buscarConferencia();">
                <div class="checkbox-group" style="border-bottom: none; margin-bottom: 0.5rem;"><input type="checkbox" id="isBiTremBusca" onchange="toggleBiTremSearchFields()"><label for="isBiTremBusca">A Carreta √© Bi-Trem?</label></div>
                <div class="form-group">
                    <div id="lacre-busca-normal-container"><label for="searchLacreCarreta">Buscar por Lacre VBlog</label><input type="text" id="searchLacreCarreta" placeholder="Digite o n√∫mero do lacre" required></div>
                    <div id="lacre-busca-bitrem-container" class="hidden"><label>Buscar por Lacres VBlog (Bi-Trem)</label><div class="input-group-bitrem"><div><input type="text" id="searchLacreCarreta1" placeholder="Lacre 1"></div><span class="input-divisor">/</span><div><input type="text" id="searchLacreCarreta2" placeholder="Lacre 2"></div></div></div>
                </div>
                <button type="submit" id="btnBusca" class="btn">Buscar</button>
            </form>
            <div id="recebimentoResultado"></div>
        </div>
    </div>
    <div id="customModal" class="modal-overlay">
        <div class="modal-content">
            <div id="modalMessage" class="modal-message"></div>
            <div id="confirmActions" class="modal-actions"><button id="modalCancelBtn" class="modal-btn modal-btn-cancel">Cancelar</button><button id="modalConfirmBtn" class="modal-btn modal-btn-confirm">Confirmar</button></div>
            <div id="alertActions" class="modal-actions"><button id="modalOkBtn" class="modal-btn modal-btn-ok">OK</button></div>
        </div>
    </div>

    <script>
    const BACKEND_URL = 'https://aju-app.onrender.com'; // <-- üö® VERIFIQUE SE ESTE √â O SEU LINK CORRETO DO RENDER
    let isSubmitting = false; // Vari√°vel global para evitar envios duplos

    // ========================================================================
    // L√ìGICA DE UPLOAD OTIMIZADA
    // ========================================================================
    
    async function compressAndUploadDirectly(file, msgDiv) {
        if (!file) return null;

        let fileToUpload = file;
        const isImage = file.type.match('image.*');
        
        if (isImage) {
            msgDiv.innerHTML = `<strong>Comprimindo imagem: ${file.name}...</strong>`;
            const options = { maxSizeMB: 0.8, maxWidthOrHeight: 1280, useWebWorker: true, initialQuality: 0.7 };
            try {
                fileToUpload = await imageCompression(file, options);
            } catch (error) {
                console.error("Erro na compress√£o, enviando original.", error);
            }
        }
        
        try {
            msgDiv.innerHTML = `<strong>Enviando ${isImage ? 'imagem' : 'v√≠deo'}: ${fileToUpload.name}...</strong>`;
            const response = await fetch(`${BACKEND_URL}/generate_upload_url`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ fileName: fileToUpload.name, mimeType: fileToUpload.type }),
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.erro || 'Falha ao obter URL de upload.');
            
            const { uploadUrl } = data;

            const uploadResponse = await fetch(uploadUrl, { method: 'PUT', body: fileToUpload });
            if (!uploadResponse.ok) throw new Error(`Falha no upload direto para o Google Drive do arquivo ${fileToUpload.name}.`);
            
            console.log(`Arquivo '${fileToUpload.name}' enviado com sucesso.`);
            return { name: fileToUpload.name };
        } catch (error) {
            throw error;
        }
    }

    // ========================================================================
    // SE√á√ÉO 1: REGISTRO DE SA√çDA
    // ========================================================================

    async function handleSaida(form) {
        if (isSubmitting) return;
        
        let errors = [], elementsToHighlight = [];
        form.querySelectorAll('.error-highlight').forEach(el => el.classList.remove('error-highlight'));
        form.querySelectorAll('input[type="text"][required], select[required]').forEach(input => {
            if (!input.closest('.hidden') && !input.value.trim()) {
                elementsToHighlight.push(input.closest('.form-group'));
                if (!errors.includes("Preencha todos os campos obrigat√≥rios.")) { errors.push("Preencha todos os campos obrigat√≥rios."); }
            }
        });
        form.querySelectorAll('input[type="file"][required]').forEach(input => {
            if (input.files.length === 0) {
                elementsToHighlight.push(form.querySelector(`label[for="${input.id}"]`));
                if (!errors.includes("Anexe as fotos obrigat√≥rias.")) { errors.push("Anexe as fotos obrigat√≥rias."); }
            }
        });
        if (errors.length > 0) {
            elementsToHighlight.forEach(el => el.classList.add('error-highlight'));
            showCustomAlert("Aten√ß√£o:\n\n- " + errors.join("\n- "));
            return;
        }
        
        showCustomConfirm('Confirmar o envio dos dados de sa√≠da?', async () => {
            const btn = document.getElementById('submitBtnSaida');
            const msgDiv = document.getElementById('saidaMensagem');
            isSubmitting = true;
            btn.disabled = true;
            msgDiv.className = 'mensagem info';
            msgDiv.innerHTML = '<strong>Iniciando envio...</strong>';
            msgDiv.style.display = 'block';

            try {
                const filesToUpload = [
                    form.fotoCarretaSaida.files[0],
                    form.fotoRegistroSaida.files[0],
                    form.fotoLacreSaida.files[0]
                ].filter(Boolean);

                const uploadPromises = filesToUpload.map(file => compressAndUploadDirectly(file, msgDiv));
                await Promise.all(uploadPromises);

                msgDiv.innerHTML = '<strong>Arquivos enviados! Registrando dados...</strong>';

                const formObject = {
                    vigilante: form.vigilante.value, origem: form.origem.value,
                    destino: form.destino.value, transportadora: form.transportadora.value,
                    motorista: form.motorista.value, placaCavalo: form.placaCavalo.value,
                    lacreNumero: form.lacreNumero.value, isBiTrem: form.isBiTrem.checked,
                    placaCarreta: form.placaCarreta.value, placaCarreta1: form.placaCarreta1.value,
                    placaCarreta2: form.placaCarreta2.value, lacreCarreta: form.lacreCarreta.value,
                    lacreCarreta1: form.lacreCarreta1.value, lacreCarreta2: form.lacreCarreta2.value,
                    fileCarreta: [{ name: form.fotoCarretaSaida.files[0]?.name }],
                    fileRegistroSaida: [{ name: form.fotoRegistroSaida.files[0]?.name }],
                    fileLacre: [{ name: form.fotoLacreSaida.files[0]?.name }],
                };

                const response = await fetch(`${BACKEND_URL}/registrar_saida`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }, // <-- CORRIGIDO
                    body: JSON.stringify(formObject)                  // <-- CORRIGIDO
                });

                const data = await response.json(); // <-- CORRIGIDO

                if (response.ok) { // <-- CORRIGIDO
                    msgDiv.className = 'mensagem sucesso';
                    msgDiv.innerHTML = `<strong>${data.mensagem}</strong>`;
                    form.reset();
                    form.querySelectorAll('.file-name').forEach(el => el.textContent = 'Nenhum arquivo selecionado');
                    form.querySelectorAll('.input-file-label').forEach(el => el.classList.remove('error-highlight'));
                    form.querySelectorAll('.form-group').forEach(el => el.classList.remove('error-highlight'));
                    toggleBiTremFields(); // Resetar campos bi-trem
                } else {
                    throw new Error(data.mensagem || 'Erro desconhecido ao registrar.');
                }
            } catch (error) {
                msgDiv.className = 'mensagem erro';
                msgDiv.innerHTML = `<strong>Erro: ${error.message}</strong>`;
                console.error('Erro em handleSaida:', error);
            } finally {
                isSubmitting = false;
                btn.disabled = false;
            }
        });
    }
    
    // ========================================================================
    // SE√á√ÉO 2: CONFER√äNCIA DE RECEBIMENTO
    // ========================================================================

    async function buscarConferencia() {
        if (isSubmitting) return;
        const btn = document.getElementById('btnBusca');
        const msgDiv = document.getElementById('recebimentoResultado');
        const isBiTrem = document.getElementById('isBiTremBusca').checked;
        
        let lacre_busca;
        if (isBiTrem) {
            const l1 = document.getElementById('searchLacreCarreta1').value.trim();
            const l2 = document.getElementById('searchLacreCarreta2').value.trim();
            if (!l1 || !l2) {
                showCustomAlert("Para Bi-Trem, ambos os lacres devem ser preenchidos.");
                return;
            }
            lacre_busca = `${l1} / ${l2}`;
        } else {
            lacre_busca = document.getElementById('searchLacreCarreta').value.trim();
            if (!lacre_busca) {
                showCustomAlert("Por favor, digite o n√∫mero do lacre.");
                return;
            }
        }

        isSubmitting = true;
        btn.disabled = true;
        msgDiv.innerHTML = `<div class="mensagem info"><strong>Buscando dados...</strong></div>`;

        try {
            const response = await fetch(`${BACKEND_URL}/buscar_recebimento`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lacreCarretaBusca: lacre_busca })
            });

            const data = await response.json();

            if (response.ok) {
                exibirResultados(data.resultados[0]);
            } else {
                throw new Error(data.erro || 'Erro ao buscar.');
            }
        } catch (error) {
            msgDiv.innerHTML = `<div class="mensagem erro"><strong>Erro: ${error.message}</strong></div>`;
            console.error('Erro em buscarConferencia:', error);
        } finally {
            isSubmitting = false;
            btn.disabled = false;
        }
    }

    function exibirResultados(resultado) {
        const container = document.getElementById('recebimentoResultado');
        container.innerHTML = `
            <div class="resultado-conferencia">
                <h3>Dados da Sa√≠da</h3>
                <div class="lacre-display">Lacre: ${resultado.Lacre_Carreta}</div>
                <div class="info-card">
                    <div class="info-item"><span class="info-label">Data/Hora Sa√≠da</span><span class="info-value">${resultado.Data}</span></div>
                    <div class="info-item"><span class="info-label">Vigilante</span><span class="info-value">${resultado.Vigilante}</span></div>
                    <div class="info-item"><span class="info-label">Origem</span><span class="info-value">${resultado.Origem}</span></div>
                    <div class="info-item"><span class="info-label">Destino</span><span class="info-value">${resultado.Destino}</span></div>
                    <div class="info-item"><span class="info-label">Transportadora</span><span class="info-value">${resultado.Transportadora}</span></div>
                    <div class="info-item"><span class="info-label">Motorista</span><span class="info-value">${resultado.Motorista}</span></div>
                    <div class="info-item"><span class="info-label">Placa Cavalo</span><span class="info-value">${resultado.Placa_Cavalo}</span></div>
                    <div class="info-item"><span class="info-label">Placa Carreta</span><span class="info-value">${resultado.Placa_Carreta}</span></div>
                    <div class="info-item"><span class="info-label">Lacre VOID</span><span class="info-value">${resultado.Lacre_Void}</span></div>
                </div>
                <h4>Anexos da Sa√≠da</h4>
                <div class="anexos-container">
                    <a href="${resultado.Foto_Carreta_Saida}" target="_blank" class="anexo-item">Foto da Carreta</a>
                    <a href="${resultado.Foto_Registro_Saida}" target="_blank" class="anexo-item">Foto do Registro</a>
                    <a href="${resultado.Foto_Lacre_Saida}" target="_blank" class="anexo-item">Foto do Lacre</a>
                </div>
                <hr class="divisor">
                <h4>Formul√°rio de Confer√™ncia</h4>
                <form id="recebimentoForm" onsubmit="event.preventDefault(); handleFinalizar(this, ${resultado.rowIndex});">
                    <div id="lacre-violado-group" class="form-group">
                        <label>1. O Lacre VOID estava violado? *</label>
                        <div class="radio-options">
                            <span class="radio-option-item"><input type="radio" id="lacreNao" name="lacreViolado" value="N√ÉO" required><label for="lacreNao">N√ÉO</label></span>
                            <span class="radio-option-item"><input type="radio" id="lacreSim" name="lacreViolado" value="SIM"><label for="lacreSim">SIM</label></span>
                        </div>
                    </div>
                    <div id="info-procedem-group" class="form-group">
                        <label>2. As informa√ß√µes procedem? *</label>
                        <div class="radio-options">
                            <span class="radio-option-item"><input type="radio" id="infoSim" name="informacoesProcedem" value="SIM" required><label for="infoSim">SIM</label></span>
                            <span class="radio-option-item"><input type="radio" id="infoNao" name="informacoesProcedem" value="N√ÉO"><label for="infoNao">N√ÉO</label></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="fotoStatus" class="input-file-label" data-default-text="Anexar Foto do Status da Carga *">Anexar Foto do Status da Carga *</label>
                        <input type="file" id="fotoStatus" name="fileStatus" style="display:none;" required onchange="updateFileName(this)">
                        <div class="file-name">Nenhum arquivo selecionado</div>
                    </div>
                    <div class="form-group">
                        <label for="videoAbertura" class="input-file-label" data-default-text="Anexar V√≠deo da Abertura *">Anexar V√≠deo da Abertura *</label>
                        <input type="file" id="videoAbertura" name="fileVideoAbertura" accept="video/*" style="display:none;" required onchange="updateFileName(this)">
                        <div class="file-name">Nenhum arquivo selecionado</div>
                    </div>
                    <div class="form-group">
                        <label for="fotoLacreStatus" class="input-file-label" data-default-text="Anexar Foto do Lacre (Status) *">Anexar Foto do Lacre (Status) *</label>
                        <input type="file" id="fotoLacreStatus" name="fileLacreStatus" style="display:none;" required onchange="updateFileName(this)">
                        <div class="file-name">Nenhum arquivo selecionado</div>
                    </div>
                    <div class="form-group">
                        <label for="observacoes">3. Observa√ß√µes (Obrigat√≥rio se "N√ÉO")</label>
                        <textarea id="observacoes" name="observacoes" rows="4" placeholder="Descreva qualquer diverg√™ncia..."></textarea>
                    </div>
                    <button type="submit" id="submitBtnFinalizar" class="btn">Finalizar Confer√™ncia</button>
                    <div id="recebimentoMensagem" class="mensagem"></div>
                </form>
            </div>
        `;
    }

    async function handleFinalizar(form, rowIndex) {
        if (isSubmitting) return;

        // 1. Valida√ß√£o
        let errors = [], elementsToHighlight = [];
        form.querySelectorAll('.error-highlight').forEach(el => el.classList.remove('error-highlight'));

        const lacreViolado = form.querySelector('input[name="lacreViolado"]:checked');
        const infoProcedem = form.querySelector('input[name="informacoesProcedem"]:checked');

        if (!lacreViolado) {
            errors.push("Responda se o lacre VOID foi violado.");
            elementsToHighlight.push(form.querySelector('#lacre-violado-group'));
        }
        if (!infoProcedem) {
            errors.push("Responda se as informa√ß√µes procedem.");
            elementsToHighlight.push(form.querySelector('#info-procedem-group'));
        }

        form.querySelectorAll('input[type="file"][required]').forEach(input => {
            if (input.files.length === 0) {
                elementsToHighlight.push(form.querySelector(`label[for="${input.id}"]`));
                if (!errors.includes("Anexe os arquivos obrigat√≥rios.")) {
                    errors.push("Anexe os arquivos obrigat√≥rios (Status, V√≠deo, Lacre).");
                }
            }
        });
        
        // Valida√ß√£o de observa√ß√µes
        if ((lacreViolado && lacreViolado.value === 'SIM') || (infoProcedem && infoProcedem.value === 'N√ÉO')) {
            if (!form.observacoes.value.trim()) {
                errors.push("Observa√ß√µes s√£o obrigat√≥rias caso o lacre esteja violado ou as informa√ß√µes n√£o procedam.");
                elementsToHighlight.push(form.querySelector('.form-group textarea').closest('.form-group'));
            }
        }

        if (errors.length > 0) {
            elementsToHighlight.forEach(el => el.classList.add('error-highlight'));
            showCustomAlert("Aten√ß√£o:\n\n- " + errors.join("\n- "));
            return;
        }

        // 2. Confirma√ß√£o
        showCustomConfirm('Confirmar a finaliza√ß√£o da confer√™ncia?', async () => {
            const btn = document.getElementById('submitBtnFinalizar');
            const msgDiv = document.getElementById('recebimentoMensagem');
            isSubmitting = true;
            btn.disabled = true;
            msgDiv.className = 'mensagem info';
            msgDiv.innerHTML = '<strong>Iniciando envio dos arquivos...</strong>';
            msgDiv.style.display = 'block';

            try {
                // 3. Upload de Arquivos
                const filesToUpload = [
                    form.fileStatus.files[0],
                    form.fileVideoAbertura.files[0],
                    form.fileLacreStatus.files[0]
                ].filter(Boolean);

                const uploadPromises = filesToUpload.map(file => compressAndUploadDirectly(file, msgDiv));
                await Promise.all(uploadPromises);

                msgDiv.innerHTML = '<strong>Arquivos enviados! Finalizando registro...</strong>';

                // 4. Preparar dados do formul√°rio
                const formObject = {
                    rowIndex: rowIndex,
                    lacreViolado: lacreViolado.value,
                    informacoesProcedem: infoProcedem.value,
                    observacoes: form.observacoes.value,
                    fileStatus: [{ name: form.fileStatus.files[0]?.name }],
                    fileVideoAbertura: [{ name: form.fileVideoAbertura.files[0]?.name }],
                    fileLacreStatus: [{ name: form.fileLacreStatus.files[0]?.name }],
                };

                // 5. Enviar para o backend
                const response = await fetch(`${BACKEND_URL}/finalizar_recebimento`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formObject)
                });

                const data = await response.json();

                if (response.ok) {
                    msgDiv.className = 'mensagem sucesso';
                    msgDiv.innerHTML = `<strong>${data.mensagem}</strong>`;
                    document.getElementById('recebimentoResultado').innerHTML = ''; // Limpa os resultados
                    document.getElementById('buscaForm').reset(); // Limpa a busca
                    toggleBiTremSearchFields(); // Reseta os campos de busca bi-trem
                } else {
                    throw new Error(data.mensagem || 'Erro desconhecido ao finalizar.');
                }

            } catch (error) {
                msgDiv.className = 'mensagem erro';
                msgDiv.innerHTML = `<strong>Erro: ${error.message}</strong>`;
                console.error('Erro em handleFinalizar:', error);
            } finally {
                isSubmitting = false;
                btn.disabled = false;
            }
        });
    }
    
    // ========================================================================
    // FUN√á√ïES AUXILIARES (UI)
    // ========================================================================

    function showSection(sectionId, element) {
        document.querySelectorAll('.form-section').forEach(section => section.style.display = 'none');
        document.getElementById(sectionId).style.display = 'block';
        document.querySelectorAll('.nav-button').forEach(button => button.classList.remove('active'));
        element.classList.add('active');
        document.getElementById('recebimentoResultado').innerHTML = '';
        document.getElementById('saidaMensagem').style.display = 'none';
    }

    function updateFileName(input) {
        const fileLabel = input.closest('.form-group').querySelector('.input-file-label');
        const fileNameDiv = input.closest('.form-group').querySelector('.file-name');
        if (input.files.length > 0) {
            fileNameDiv.textContent = input.files[0].name;
            fileLabel.classList.remove('error-highlight');
        } else {
            fileNameDiv.textContent = 'Nenhum arquivo selecionado';
        }
    }

    function toggleBiTremFields() {
        const isChecked = document.getElementById('isBiTrem').checked;
        document.getElementById('placa-normal-container').classList.toggle('hidden', isChecked);
        document.getElementById('placa-bitrem-container').classList.toggle('hidden', !isChecked);
        document.getElementById('lacre-normal-container').classList.toggle('hidden', isChecked);
        document.getElementById('lacre-bitrem-container').classList.toggle('hidden', !isChecked);

        // Alternar 'required'
        document.getElementById('placaCarreta').required = !isChecked;
        document.getElementById('lacreCarreta').required = !isChecked;
        document.getElementById('placaCarreta1').required = isChecked;
        document.getElementById('placaCarreta2').required = isChecked;
        document.getElementById('lacreCarreta1').required = isChecked;
        document.getElementById('lacreCarreta2').required = isChecked;
    }
    
    function toggleBiTremSearchFields() {
        const isChecked = document.getElementById('isBiTremBusca').checked;
        document.getElementById('lacre-busca-normal-container').classList.toggle('hidden', isChecked);
        document.getElementById('lacre-busca-bitrem-container').classList.toggle('hidden', !isChecked);
        
        // Alternar 'required'
        document.getElementById('searchLacreCarreta').required = !isChecked;
        // Os campos de busca bi-trem s√£o validados na pr√≥pria fun√ß√£o JS
    }

    function showCustomAlert(message) {
        const modal = document.getElementById('customModal');
        document.getElementById('modalMessage').textContent = message;
        document.getElementById('confirmActions').style.display = 'none';
        document.getElementById('alertActions').style.display = 'flex';
        modal.classList.add('show');
        document.getElementById('modalOkBtn').onclick = () => modal.classList.remove('show');
    }

    function showCustomConfirm(message, onConfirm) {
        const modal = document.getElementById('customModal');
        document.getElementById('modalMessage').textContent = message;
        document.getElementById('confirmActions').style.display = 'flex';
        document.getElementById('alertActions').style.display = 'none';
        modal.classList.add('show');
        document.getElementById('modalConfirmBtn').onclick = () => {
            modal.classList.remove('show');
            onConfirm();
        };
        document.getElementById('modalCancelBtn').onclick = () => modal.classList.remove('show');
    }

    // Inicializar os labels dos arquivos
    document.querySelectorAll('.input-file-label').forEach(label => {
        label.addEventListener('click', () => {
            document.getElementById(label.getAttribute('for')).click();
        });
    });
    </script>
</body>
</html>